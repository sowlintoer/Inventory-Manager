<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Pro 2026 - Google Sheets Sync</title>
    <style>
        :root { --primary: #007bff; --success: #28a745; --dark: #212529; --light: #f8f9fa; }
        body { font-family: 'Inter', system-ui, sans-serif; margin: 0; background: #eef2f7; color: #333; }
        
        .tab-bar { display: flex; background: var(--dark); padding: 0 10%; position: sticky; top: 0; z-index: 100; }
        .tab-btn { padding: 18px 25px; border: none; background: none; color: #adb5bd; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .tab-btn.active { color: white; border-bottom: 4px solid var(--primary); }

        .container { max-width: 1100px; margin: 30px auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .card { border: 1px solid #e0e6ed; padding: 20px; border-radius: 10px; margin-bottom: 25px; background: #fdfdfd; }
        .form-grid { display: grid; gap: 15px; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
        
        input, select { width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 14px; margin-top: 5px; }
        label { font-size: 13px; font-weight: 700; color: #495057; }

        .upload-box { border: 2px dashed #007bff; padding: 20px; text-align: center; border-radius: 10px; background: #f0f7ff; margin-top: 15px; }
        .btn { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; width: 100%; margin-top: 15px; }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); margin-top: 10px; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { text-align: left; padding: 15px; background: #f8f9fa; font-size: 12px; color: #888; text-transform: uppercase; }
        td { padding: 15px; border-top: 1px solid #eee; font-size: 14px; }
        
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .in { background: #d1e7dd; color: #0f5132; }
        .out { background: #f8d7da; color: #842029; }
        
        .sync-status { font-size: 12px; color: var(--success); text-align: right; margin-bottom: 10px; }
        .loading-overlay { font-style: italic; color: #666; }
    </style>
</head>
<body>

<div class="tab-bar">
    <button class="tab-btn active" onclick="showTab('inventory')">Dashboard</button>
    <button class="tab-btn" onclick="showTab('log')">Post Transaction</button>
    <button class="tab-btn" onclick="showTab('history')">History</button>
</div>

<div class="container">
    <div class="sync-status" id="syncStat">● Connecting to Google Sheets...</div>

    <div id="inventory" class="tab-content active">
        <h2>Stock Inventory</h2>
        <div id="loadMsg" class="loading-overlay">Fetching live data...</div>
        <table>
            <thead><tr><th>Item Name</th><th>Location</th><th>Balance</th></tr></thead>
            <tbody id="stockTableBody"></tbody>
        </table>
    </div>

    <div id="log" class="tab-content">
        <h2>New Transaction</h2>
        <div class="card">
            <div class="form-grid">
                <div><label>Date</label><input type="date" id="txnDate"></div>
                <div>
                    <label>Item Source</label>
                    <select id="entryMode" onchange="toggleEntryMode()">
                        <option value="existing">Existing Item</option>
                        <option value="new">Add New (Manual)</option>
                        <option value="bulk">Bulk Upload (CSV)</option>
                    </select>
                </div>
                <div id="existingWrap"><label>Select Item</label><select id="itemSelect"></select></div>
                <div id="newWrap" style="display:none;"><label>Item Name</label><input type="text" id="newName"></div>
                <div id="locWrap" style="display:none;"><label>Location</label><input type="text" id="newLoc"></div>
            </div>

            <div id="bulkWrap" class="upload-box" style="display:none;">
                <strong>Upload CSV File</strong><br>
                <small>Format: Item Name, Location, Initial Stock</small><br>
                <input type="file" id="csvFile" accept=".csv" class="btn-outline">
                <button class="btn btn-outline" onclick="handleFileUpload()">Process CSV</button>
            </div>

            <div class="form-grid" style="margin-top:15px;">
                <div><label>Transaction Type</label>
                    <select id="txnType">
                        <option value="Input">Input (In)</option>
                        <option value="Output">Output (Out)</option>
                    </select>
                </div>
                <div><label>Quantity</label><input type="number" id="txnQty" placeholder="0"></div>
                <div style="grid-column: span 2;"><label>Remarks</label><input type="text" id="txnRem" placeholder="Invoice / Customer"></div>
            </div>
            <button id="submitBtn" class="btn btn-primary" onclick="saveTransaction()">Confirm & Sync to Sheet</button>
        </div>
    </div>

    <div id="history" class="tab-content">
        <h2>Transaction History</h2>
        <table>
            <thead><tr><th>Date</th><th>Item</th><th>Type</th><th>Qty</th><th>Remarks</th></tr></thead>
            <tbody id="historyBody"></tbody>
        </table>
        <button class="btn btn-outline" onclick="clearData()" style="color:red; border-color:red; width:auto;">Clear Local Cache</button>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    const SCRIPT_URL = "YOUR_DEPLOYED_WEB_APP_URL_HERE";

    let inventory = JSON.parse(localStorage.getItem('inventory')) || {};
    let historyLog = JSON.parse(localStorage.getItem('historyLog')) || [];

    // DATA SYNC LOGIC
    async function loadFromSheet() {
        if(!SCRIPT_URL.includes("http")) return;
        try {
            const response = await fetch(SCRIPT_URL);
            const data = await response.json();
            
            // Format: [Item, Location, Balance] assuming header row exists
            const newInv = {};
            for(let i = 1; i < data.length; i++) {
                const [name, loc, bal] = data[i];
                if(name) newInv[name.trim()] = { location: loc, balance: parseFloat(bal) || 0 };
            }
            inventory = newInv;
            document.getElementById('syncStat').innerText = "● Google Sheets Synced";
            document.getElementById('loadMsg').style.display = "none";
            syncData(); // Update LocalStorage with Sheet data
        } catch (e) {
            document.getElementById('syncStat').innerText = "● Using Local Data (Offline)";
            console.error("Sync error:", e);
        }
    }

    function syncData() {
        localStorage.setItem('inventory', JSON.stringify(inventory));
        localStorage.setItem('historyLog', JSON.stringify(historyLog));
        updateUI();
    }

    function showTab(id) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    function toggleEntryMode() {
        const mode = document.getElementById('entryMode').value;
        document.getElementById('existingWrap').style.display = mode === 'existing' ? 'block' : 'none';
        document.getElementById('newWrap').style.display = mode === 'new' ? 'block' : 'none';
        document.getElementById('locWrap').style.display = mode === 'new' ? 'block' : 'none';
        document.getElementById('bulkWrap').style.display = mode === 'bulk' ? 'block' : 'none';
    }

    function handleFileUpload() {
        const file = document.getElementById('csvFile').files[0];
        if (!file) return alert("Select a file first");

        const reader = new FileReader();
        reader.onload = function(e) {
            const rows = e.target.result.split('\n');
            rows.forEach(row => {
                const [name, loc, stock] = row.split(',');
                if (name && loc) {
                    inventory[name.trim()] = { location: loc.trim(), balance: parseInt(stock) || 0 };
                }
            });
            syncData();
            alert("Bulk items imported successfully!");
        };
        reader.readAsText(file);
    }

    async function saveTransaction() {
        const date = document.getElementById('txnDate').value;
        const type = document.getElementById('txnType').value;
        const qty = parseInt(document.getElementById('txnQty').value);
        const mode = document.getElementById('entryMode').value;
        const rem = document.getElementById('txnRem').value;
        const btn = document.getElementById('submitBtn');
        let itemName = "";
        let locName = "";

        if (!date || isNaN(qty)) return alert("Fill required fields");

        if (mode === 'new') {
            itemName = document.getElementById('newName').value;
            locName = document.getElementById('newLoc').value;
            inventory[itemName] = { location: locName, balance: 0 };
        } else {
            itemName = document.getElementById('itemSelect').value;
            locName = inventory[itemName].location;
        }

        // Update Local State
        if (type === 'Input') inventory[itemName].balance += qty;
        else inventory[itemName].balance -= qty;

        const txnObj = { date, item: itemName, type, qty, rem, location: locName };
        historyLog.push(txnObj);
        
        // Push to Google Sheets
        btn.disabled = true;
        btn.innerText = "Syncing...";
        
        try {
            await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', // Essential for Google Apps Script POST
                body: JSON.stringify(txnObj)
            });
            document.getElementById('syncStat').innerText = "● Last Sync: " + new Date().toLocaleTimeString();
        } catch (e) {
            alert("Local save successful, but Google Sync failed.");
        }

        btn.disabled = false;
        btn.innerText = "Confirm & Sync to Sheet";
        syncData();
        alert("Transaction Saved");
    }

    function updateUI() {
        const sBody = document.getElementById('stockTableBody');
        const hBody = document.getElementById('historyBody');
        const sel = document.getElementById('itemSelect');
        sBody.innerHTML = ''; hBody.innerHTML = ''; sel.innerHTML = '';
        
        for (let item in inventory) {
            sBody.innerHTML += `<tr><td>${item}</td><td>${inventory[item].location}</td><td>${inventory[item].balance}</td></tr>`;
            sel.innerHTML += `<option value="${item}">${item}</option>`;
        }

        historyLog.slice().reverse().forEach(h => {
            hBody.innerHTML += `<tr><td>${h.date}</td><td>${h.item}</td><td><span class="badge ${h.type === 'Input' ? 'in' : 'out'}">${h.type}</span></td><td>${h.qty}</td><td>${h.rem}</td></tr>`;
        });
    }

    function clearData() { if(confirm("Delete local cache? This won't delete the Google Sheet.")) { localStorage.clear(); location.reload(); } }

    // INITIALIZE
    document.getElementById('txnDate').valueAsDate = new Date();
    loadFromSheet().then(updateUI);
</script>
</body>
</html>
